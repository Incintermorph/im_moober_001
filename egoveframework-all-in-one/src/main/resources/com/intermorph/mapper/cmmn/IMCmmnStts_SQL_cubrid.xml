<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.intermorph.cmmn.service.IMCmmnSttsMapper">

    <insert id="insert" parameterType="com.intermorph.cmmn.service.IMCmmnSttsVO" useGeneratedKeys="false">
/* IMCmmnSttsMapper.insert */
INSERT INTO im_cmmn_stts (
    tbl_id,
    tbl_ref_id,
    ref_nm,
    stts_cdv,
	stts_rmks,
    frst_reger_id,
    frst_reg_dt,
    frst_reger_ip
) VALUES (
    #{tblId, jdbcType=VARCHAR},
    #{tblRefId, jdbcType=VARCHAR},
    #{refNm, jdbcType=VARCHAR},
    #{sttsCdv, jdbcType=VARCHAR},
    #{sttsRmks, jdbcType=VARCHAR},
    
    #{frstRegerId, jdbcType=VARCHAR},
    TO_CHAR(SYSDATETIME, 'yyyymmddhh24miss'),
    #{frstRegerIp, jdbcType=VARCHAR}
) 
    </insert>
    
    
    
    <insert id="insertHstry" parameterType="com.intermorph.cmmn.service.IMCmmnSttsVO" useGeneratedKeys="false">
/* IMCmmnSttsMapper.insertHstry */
INSERT INTO im_cmmn_stts_hstry (
    tbl_id,
    tbl_ref_id,
    ref_nm,
    hstry_dt,
    stts_cdv,
	stts_rmks,
    frst_reger_id,
    frst_reg_dt,
    frst_reger_ip
) VALUES (
    #{tblId, jdbcType=VARCHAR},
    #{tblRefId, jdbcType=VARCHAR},
    #{refNm, jdbcType=VARCHAR},
    TO_CHAR(SYSDATETIME, 'yyyymmddhh24miss'),
    #{sttsCdv, jdbcType=VARCHAR},
    #{sttsRmks, jdbcType=VARCHAR},
    
    #{frstRegerId, jdbcType=VARCHAR},
    TO_CHAR(SYSDATETIME, 'yyyymmddhh24miss'),
    #{frstRegerIp, jdbcType=VARCHAR}
) 
    </insert>

    <update id="update" parameterType="com.intermorph.cmmn.service.IMCmmnSttsVO">
/* IMCmmnSttsMapper.update */
UPDATE im_cmmn_stts
   SET 
       stts_cdv = #{sttsCdv, jdbcType=VARCHAR},
       <if test='sttsRmks != null'>
       stts_rmks = #{sttsRmks, jdbcType=VARCHAR},
       </if>
	   last_mdfer_id = #{lastMdferId, jdbcType=VARCHAR},
       last_mdfcn_dt = TO_CHAR(SYSDATETIME, 'yyyymmddhh24miss'),
       last_mdfer_ip = #{lastMdferIp, jdbcType=VARCHAR}
 
 WHERE
       tbl_id = #{tblId}
       AND tbl_ref_id = #{tblRefId}
       AND ref_nm = #{refNm} 
    </update>

    <select id="selectList" parameterType="com.intermorph.cmmn.service.IMCmmnSttsVO" resultType="com.intermorph.cmmn.service.IMCmmnSttsVO">
/* IMCmmnSttsMapper.selectList */

SELECT
       A.tbl_id AS "tblId",
       A.tbl_ref_id AS "tblRefId",
       A.ref_nm AS "refNm",
       A.stts_cdv AS "sttsCdv",
       A.stts_rmks AS "sttsRmks"

  FROM im_cmmn_stts A
 WHERE 
 		tbl_id = #{tblId}
       AND tbl_ref_id = #{tblRefId} 		
    </select>
    
    
    <resultMap id="selectListResultMap" type="com.intermorph.cmmn.service.IMCmmnSttsResultSet">
        <result column="A.tblId" property="cmmnStts.tblId"/>
        <result column="A.tblRefId" property="cmmnStts.tblRefId"/>
        <result column="A.refNm" property="cmmnStts.refNm"/>
        <result column="A.sttsCdv" property="cmmnStts.sttsCdv"/>
        <result column="A.frstRegerId" property="cmmnStts.frstRegerId"/>
        <result column="A.frstRegDt" property="cmmnStts.frstRegDt"/>
        <result column="A.frstRegerIp" property="cmmnStts.frstRegerIp"/>
        <result column="A.lastMdferId" property="cmmnStts.lastMdferId"/>
        <result column="A.lastMdfcnDt" property="cmmnStts.lastMdfcnDt"/>
        <result column="A.lastMdferIp" property="cmmnStts.lastMdferIp"/>
        <result column="A.sttsRmks" property="cmmnStts.sttsRmks"/>
		<result column="B.mberId" property="mberManage.mberId"/>
        <result column="B.mberNm" property="mberManage.mberNm"/>
        <result column="B.userTy" property="mberManage.userTy"/>
    </resultMap>
    <select id="selectListHstry" parameterType="com.intermorph.cmmn.service.IMCmmnSttsCondition" resultMap="selectListResultMap">
/* IMCmmnSttsMapper.selectList */
         <if test='currentPageNo != 0'>
SELECT * FROM ( SELECT rownum rn, TB.* FROM (
        </if>
SELECT
       A.tbl_id AS "A.tblId",
       A.tbl_ref_id AS "A.tblRefId",
       A.ref_nm AS "A.refNm",
       A.stts_cdv AS "A.sttsCdv",
       A.frst_reger_id AS "A.frstRegerId",
       A.frst_reg_dt AS "A.frstRegDt",
       A.frst_reger_ip AS "A.frstRegerIp",
       A.stts_rmks AS "A.sttsRmks",
       B.user_id AS "B.mberId",
       B.user_nm AS "B.mberNm",
       B.user_se AS "B.userTy"

  FROM im_cmmn_stts_hstry A
  INNER JOIN comvnusermaster B ON A.frst_reger_id=B.esntl_id
 WHERE 
 			A.tbl_id  = #{scTblId}
  		AND A.tbl_ref_id=#{scTblRefId}
  		<if test='scWord != null and !scWord.equals("")'>
            <if test='scKey.equals("mberId")'>
       			AND B.user_id LIKE CONCAT('%', #{scWord}, '%')
            </if>
            <if test='scKey.equals("mmbrNm")'>
       			AND B.user_nm LIKE CONCAT('%', #{scWord}, '%')
            </if>
        </if>
        
  		<if test='scRefNm != null and !scRefNm.equals("")'>
  		AND A.ref_nm = #{scRefNm}
  		</if>
  		<if test='scSttsCdv != null and !scSttsCdv.equals("")'>
  		AND A.stts_cdv = #{scSttsCdv}
  		</if>
 
  		<choose>
            <when test='orderbyKey == 1'>ORDER BY A.frst_reg_dt ASC</when>
            <when test='orderbyKey == -1'>ORDER BY A.frst_reg_dt DESC</when>
            <otherwise>ORDER BY A.frst_reg_dt DESC</otherwise>
        </choose>

        <if test='currentPageNo != 0'>
        ) TB ) WHERE rn BETWEEN #{firstItemNo}+1  AND #{firstItemNo} + #{recordCountPerPage}
        </if>
    </select>

    <select id="selectListHstryCount" parameterType="com.intermorph.cmmn.service.IMCmmnSttsCondition" resultType="int">
/* IMCmmnSttsMapper.selectListCount */
SELECT COUNT(*) 
  FROM im_cmmn_stts_hstry A
  INNER JOIN comvnusermaster B ON A.frst_reger_id=B.esntl_id
 WHERE 
 		A.tbl_id  = #{scTblId}
  		AND A.tbl_ref_id=#{scTblRefId}
  		<if test='scWord != null and !scWord.equals("")'>
            <if test='scKey.equals("mberId")'>
       			AND B.user_id LIKE CONCAT('%', #{scWord}, '%')
            </if>
            <if test='scKey.equals("mmbrNm")'>
       			AND B.user_nm LIKE CONCAT('%', #{scWord}, '%')
            </if>
        </if>
  		<if test='scRefNm != null and !scRefNm.equals("")'>
  		AND A.ref_nm = #{scRefNm}
  		</if>
  		<if test='scSttsCdv != null and !scSttsCdv.equals("")'>
  		AND A.stts_cdv = #{scSttsCdv}
  		</if>
    </select>
    

</mapper>