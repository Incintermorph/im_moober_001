<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.intermorph.crs.aplcnt.service.IMCrsAplcntMapper">

    <insert id="insert" parameterType="com.intermorph.crs.aplcnt.service.IMCrsAplcntVO" useGeneratedKeys="false">
/* IMCrsAplcntMapper.insert */
INSERT INTO im_crs_aplcnt (
    crs_aplcnt_id,
    crs_id,
    mmbr_esntl_id,
    mber_id,
    mber_nm,
    mber_email_adres,
    mmbr_telno,
    
    
	ttnfee_chg_cdv,
	dsr_aply_grd_cdv,
	expt_sbj_yn,
	
	agncy_code,
	agncy_nm,
	work_dvsn_cdv,

    del_yn,
    frst_reger_id,
    frst_reg_dt,
    frst_reger_ip
)
SELECT 
	#{crsAplcntId, jdbcType=VARCHAR},
    #{crsId, jdbcType=VARCHAR},
	A.esntl_id,
    A.mber_id,
    A.mber_nm,
    A.mber_email_adres,
    A.mbtlnum ,
    
    '01',
    NVL(B.aply_grd_cdv,#{dsrAplyGrdCdv}),
    B.expt_sbj_yn,
    
	#{agncyCode, jdbcType=VARCHAR},
	#{agncyNm, jdbcType=VARCHAR},
	#{workDvsnCdv, jdbcType=VARCHAR},
    
     'N',
    #{frstRegerId, jdbcType=VARCHAR},
    TO_CHAR(SYSDATETIME, 'yyyymmddhh24miss'),
    #{frstRegerIp, jdbcType=VARCHAR}
    
FROM   COMTNGNRLMBER A
LEFT OUTER JOIN 
(
SELECT   esntl_id,
         MAX(aply_grd_cdv) aply_grd_cdv,
         MAX(expt_sbj_yn) expt_sbj_yn
FROM     im_mmbr_hstry
WHERE  esntl_id=#{mmbrEsntlId, jdbcType=VARCHAR}
GROUP BY esntl_id

) B ON A.esntl_id=B.esntl_id
WHERE  A.esntl_id=#{mmbrEsntlId, jdbcType=VARCHAR}
        </insert>
        
        
    <insert id="insertRslt" parameterType="com.intermorph.crs.aplcnt.service.IMCrsAplcntVO" useGeneratedKeys="false">
/* IMCrsAplcntMapper.insertRslt */
INSERT INTO im_crs_aplcnt_rslt (
    crs_aplcnt_id,
    crs_id,
    mmbr_esntl_id,
    mber_id,
    mber_nm,
    mber_email_adres,
    mmbr_telno,
    brdt,
    dsr_aply_grd_cdv,
    expt_sbj_yn,
    ttnfee_chg_cdv,
    ttnfee,
    edu_hrs,
    
    
	agncy_code,
	agncy_nm,
	work_dvsn_cdv,
	agncy_id,
	crs_grd_cdv,
    crs_dvsn_cdv,
    
    fnsh_stts_cdv,
    fnsh_rslt_code,
    fnsh_ymd,
    fnsh_vld_ymd,
    qlfc_acqs_ymd,
    qlfc_stts_cdv,
    qlfc_rslt_code,
    qlfc_vld_ymd,
    
    frst_reger_id,
    frst_reg_dt,
    frst_reger_ip
) 
SELECT
	#{crsAplcntId, jdbcType=VARCHAR},
    A.crs_id,
    A.mmbr_esntl_id,
    A.mber_id,
    A.mber_nm,
    A.mber_email_adres,
    A.mmbr_telno,
    #{brdt, jdbcType=VARCHAR},
    A.dsr_aply_grd_cdv,
    A.expt_sbj_yn,
    A.ttnfee_chg_cdv,
    A.ttnfee,
    #{eduHrs, jdbcType=VARCHAR},
    
	A.agncy_code,
	A.agncy_nm,
	A.work_dvsn_cdv,
	#{agncyId, jdbcType=VARCHAR},
	#{crsGrdCdv, jdbcType=VARCHAR},
	#{crsDvsnCdv, jdbcType=VARCHAR},
    
    
    #{fnshSttsCdv, jdbcType=VARCHAR},
    #{fnshRsltCode, jdbcType=VARCHAR},
    #{fnshYmd, jdbcType=VARCHAR},
    #{fnshVldYmd, jdbcType=VARCHAR},
    
    
    #{qlfcAcqsYmd, jdbcType=VARCHAR},
    #{qlfcSttsCdv, jdbcType=VARCHAR},
    #{qlfcRsltCode, jdbcType=VARCHAR},
    #{qlfcVldYmd, jdbcType=VARCHAR},
    
    #{frstRegerId, jdbcType=VARCHAR},
    TO_CHAR(SYSDATETIME, 'yyyymmddhh24miss'),
    #{frstRegerIp, jdbcType=VARCHAR}
FROM
im_crs_aplcnt A
WHERE  crs_aplcnt_id = #{crsAplcntId}
    </insert>

    <update id="update" parameterType="com.intermorph.crs.aplcnt.service.IMCrsAplcntVO">
/* IMCrsAplcntMapper.update */
UPDATE im_crs_aplcnt
   SET 
		<if test='ttnfeeChgCdv != null'>
       ttnfee_chg_cdv = #{ttnfeeChgCdv, jdbcType=VARCHAR},
       ttnfee = #{ttnfee, jdbcType=VARCHAR},
       </if>
	   last_mdfer_id = #{lastMdferId, jdbcType=VARCHAR},
       last_mdfcn_dt = TO_CHAR(SYSDATETIME, 'yyyymmddhh24miss'),
       last_mdfer_ip = #{lastMdferIp, jdbcType=VARCHAR}
 WHERE
       crs_aplcnt_id = #{crsAplcntId} 
    </update>
    
    <update id="updateRslt" parameterType="com.intermorph.crs.aplcnt.service.IMCrsAplcntVO">
/* IMCrsAplcntMapper.updateRslt */
UPDATE im_crs_aplcnt_rslt
   SET 
   		
		<if test='fnshSttsCdv != null'>
       fnsh_stts_cdv = #{fnshSttsCdv, jdbcType=VARCHAR},
       fnsh_rslt_code = #{fnshRsltCode, jdbcType=VARCHAR},
       fnsh_ymd = #{fnshYmd, jdbcType=VARCHAR},
       fnsh_vld_ymd = #{fnshVldYmd, jdbcType=VARCHAR},
        </if>

       <if test='qlfcSttsCdv != null'>
       qlfc_stts_cdv = #{qlfcSttsCdv, jdbcType=VARCHAR},
       qlfc_rslt_code = #{qlfcRsltCode, jdbcType=VARCHAR},
       qlfc_acqs_ymd = #{qlfcAcqsYmd, jdbcType=VARCHAR},
       qlfc_vld_ymd = #{qlfcVldYmd, jdbcType=VARCHAR},
       </if>

	   last_mdfer_id = #{lastMdferId, jdbcType=VARCHAR},
       last_mdfcn_dt = TO_CHAR(SYSDATETIME, 'yyyymmddhh24miss'),
       last_mdfer_ip = #{lastMdferIp, jdbcType=VARCHAR}
 WHERE
       crs_aplcnt_id = #{crsAplcntId} 
    </update>

    <update id="delete" parameterType="com.intermorph.crs.aplcnt.service.IMCrsAplcntVO">
/* IMCrsAplcntMapper.delete */
UPDATE im_crs_aplcnt 
   SET last_mdfer_id = #{lastMdferId, jdbcType=VARCHAR},
       last_mdfcn_dt = TO_CHAR(SYSDATETIME, 'yyyymmddhh24miss'),
       last_mdfer_ip = #{lastMdferIp, jdbcType=VARCHAR},
       del_yn = 'Y' 
 WHERE 
       crs_aplcnt_id = #{crsAplcntId}

   AND del_yn = 'N'
    </update>

    <resultMap id="selectDetailResultMap" type="com.intermorph.crs.aplcnt.service.IMCrsAplcntResultSet">
        <result column="A.crsAplcntId" property="crsAplcnt.crsAplcntId"/>
        <result column="A.crsId" property="crsAplcnt.crsId"/>
        <result column="A.mmbrEsntlId" property="crsAplcnt.mmbrEsntlId"/>        
        <result column="A.mberId" property="crsAplcnt.mberId"/>
        <result column="A.mberNm" property="crsAplcnt.mberNm"/>
        <result column="A.mberEmailAdres" property="crsAplcnt.mberEmailAdres"/>
        <result column="A.mmbrTelno" property="crsAplcnt.mmbrTelno"/>
        <result column="A.dsrAplyGrdCdv" property="crsAplcnt.dsrAplyGrdCdv"/>
        <result column="A.exptSbjYn" property="crsAplcnt.exptSbjYn"/>
        <result column="A.ttnfeeChgCdv" property="crsAplcnt.ttnfeeChgCdv"/>
        <result column="A.ttnfee" property="crsAplcnt.ttnfee"/>
        <result column="A.agncyNm" property="crsAplcnt.agncyNm"/>
        <result column="A.agncyCode" property="crsAplcnt.agncyCode"/>
        <result column="A.workDvsnCdv" property="crsAplcnt.workDvsnCdv"/>
        
        
        
        <result column="B.ttnfee" property="crs.ttnfee"/>
        <result column="A.delYn" property="crsAplcnt.delYn"/>
        <result column="A.frstRegerId" property="crsAplcnt.frstRegerId"/>
        <result column="A.frstRegDt" property="crsAplcnt.frstRegDt"/>
        <result column="A.frstRegerIp" property="crsAplcnt.frstRegerIp"/>
        <result column="A.lastMdferId" property="crsAplcnt.lastMdferId"/>
        <result column="A.lastMdfcnDt" property="crsAplcnt.lastMdfcnDt"/>
        <result column="A.lastMdferIp" property="crsAplcnt.lastMdferIp"/>

    </resultMap>
    <select id="selectDetail" parameterType="com.intermorph.crs.aplcnt.service.IMCrsAplcntVO" resultMap="selectDetailResultMap">
        /* IMCrsAplcntMapper.selectDetail */
SELECT 
       A.crs_aplcnt_id AS "A.crsAplcntId",
       A.crs_id AS "A.crsId",
       A.mmbr_esntl_id AS "A.mmbrEsntlId",
       A.mber_id AS "A.mberId",
       A.mber_nm AS "A.mberNm",
       A.mber_email_adres AS "A.mberEmailAdres",
       A.mmbr_telno AS "A.mmbrTelno",
       A.agncy_code AS "A.agncyCode",
	   A.agncy_nm AS "A.agncyNm",
	   A.work_dvsn_cdv  AS "A.workDvsnCdv",
       A.ttnfee_chg_cdv AS "A.ttnfeeChgCdv",
       A.dsr_aply_grd_cdv AS "A.dsrAplyGrdCdv",
       A.expt_sbj_yn AS "A.exptSbjYn",
       CASE 
       	WHEN A.ttnfee_chg_cdv IS NULL THEN B.ttnfee
        WHEN A.ttnfee_chg_cdv ='01' THEN B.ttnfee
        ELSE A.ttnfee
       END AS   "A.ttnfee",
       B.ttnfee AS "B.ttnfee",
       A.del_yn AS "A.delYn",
       A.frst_reger_id AS "A.frstRegerId",
       A.frst_reg_dt AS "A.frstRegDt",
       A.frst_reger_ip AS "A.frstRegerIp",
       A.last_mdfer_id AS "A.lastMdferId",
       A.last_mdfcn_dt AS "A.lastMdfcnDt",
       A.last_mdfer_ip AS "A.lastMdferIp"
  
  FROM im_crs_aplcnt A
  INNER JOIN im_crs B ON A.crs_id=B.crs_id
 WHERE
       crs_aplcnt_id = #{crsAplcntId}

   AND A.del_yn = 'N'
    </select>
    
    
    <select id="selectDetailResult" parameterType="map" resultType="com.intermorph.crs.aplcnt.service.IMCrsAplcntVO">
        /* IMCrsAplcntRsltMapper.selectDetailResult */
SELECT 
       A.crs_aplcnt_id AS "crsAplcntId",
       A.crs_id AS "crsId",
       A.mmbr_esntl_id AS "mmbrEsntlId",
       A.mber_id AS "mberId",
       A.mber_nm AS "mberNm",
       A.mber_email_adres AS "mberEmailAdres",
       A.mmbr_telno AS "mmbrTelno",
       A.brdt AS "brdt",
       A.dsr_aply_grd_cdv AS "dsrAplyGrdCdv",
       A.expt_sbj_yn AS "exptSbjYn",
       A.ttnfee_chg_cdv AS "ttnfeeChgCdv",
       A.ttnfee AS "ttnfee",
       A.fnsh_stts_cdv AS "fnshSttsCdv",
       A.fnsh_rslt_code AS "fnshRsltCode",
       A.fnsh_ymd AS "fnshYmd",
       A.edu_hrs AS "eduHrs",
		A.agncy_code AS "agncyCode",
		A.agncy_nm AS "agncyNm",
		A.work_dvsn_cdv AS "workDvsnCdv",
		A.agncy_id AS "agncyId",
		A.crs_grd_cdv AS "crsGrdCdv",
	    A.crs_dvsn_cdv AS "crsDvsnCdv",
       A.qlfc_stts_cdv AS "qlfcSttsCdv",
       A.qlfc_rslt_code AS "qlfcRsltCode",
       A.qlfc_acqs_ymd AS "qlfcAcqsYmd",       
	   A.qlfc_vld_ymd AS  "A.qlfcVldYmd",
	   A.fnsh_vld_ymd AS  "A.fnshVldYmd"
  
  FROM im_crs_aplcnt_rslt A
 WHERE
       crs_aplcnt_id = #{crsAplcntId}
    </select>


    <resultMap id="selectListResultMap" type="com.intermorph.crs.aplcnt.service.IMCrsAplcntResultSet">
        <result column="A.crsAplcntId" property="crsAplcnt.crsAplcntId"/>
        <result column="A.crsId" property="crsAplcnt.crsId"/>
        <result column="A.mmbrEsntlId" property="crsAplcnt.mmbrEsntlId"/>
        <result column="A.mberId" property="crsAplcnt.mberId"/>
        <result column="A.mberNm" property="crsAplcnt.mberNm"/>
        <result column="A.mberEmailAdres" property="crsAplcnt.mberEmailAdres"/>
        <result column="A.mmbrTelno" property="crsAplcnt.mmbrTelno"/>
        <result column="A.dsrAplyGrdCdv" property="crsAplcnt.dsrAplyGrdCdv"/>
        <result column="A.exptSbjYn" property="crsAplcnt.exptSbjYn"/>
        <result column="A.ttnfeeChgCdv" property="crsAplcnt.ttnfeeChgCdv"/>
        <result column="A.ttnfee" property="crsAplcnt.ttnfee"/>
        <result column="A.agncyNm" property="crsAplcnt.agncyNm"/>
        <result column="A.agncyCode" property="crsAplcnt.agncyCode"/>
        <result column="A.workDvsnCdv" property="crsAplcnt.workDvsnCdv"/>
        <result column="A.delYn" property="crsAplcnt.delYn"/>
        <result column="A.frstRegerId" property="crsAplcnt.frstRegerId"/>
        <result column="A.frstRegDt" property="crsAplcnt.frstRegDt"/>
        <result column="A.frstRegerIp" property="crsAplcnt.frstRegerIp"/>
        <result column="A.lastMdferId" property="crsAplcnt.lastMdferId"/>
        <result column="A.lastMdfcnDt" property="crsAplcnt.lastMdfcnDt"/>
        <result column="A.lastMdferIp" property="crsAplcnt.lastMdferIp"/>
        <result column="sttDdvs" property="sttDdvs"/>
        <result column="sttDdvIds" property="sttDdvIds"/>
        <result column="sttDdvDts" property="sttDdvDts"/>
        <result column="rndmCdv" property="rndmCdv"/>
        <result column="agncySrngCdv" property="agncySrngCdv"/>
        <result column="opsectSrngCdv" property="opsectSrngCdv"/>
        <result column="agncySrngRmks" property="agncySrngRmks"/>
        <result column="opsectSrngRmks" property="opsectSrngRmks"/>
        <result column="D.crsGrdCdv" property="crsMstr.crsGrdCdv"/>
        <result column="D.crsDvsnCdv" property="crsMstr.crsDvsnCdv"/>
        <result column="E.agncyNm" property="agncy.agncyNm"/>
        <result column="E.areaCdv" property="agncy.areaCdv"/>
        <result column="C.eduYear" property="crs.eduYear"/>
        <result column="C.eduRnd" property="crs.eduRnd"/>
        <result column="C.ttnfee" property="crs.ttnfee"/>
        <result column="C.eduHrs" property="crs.eduHrs"/>
        <result column="C.prgrsSttsCdv" property="crs.prgrsSttsCdv"/>
        
        
        <result column="A.fnshSttsCdv" property="crsAplcnt.fnshSttsCdv"/>
        <result column="A.fnshRsltCode" property="crsAplcnt.fnshRsltCode"/>
        <result column="A.fnshYmd" property="crsAplcnt.fnshYmd"/>
        
        <result column="A.brdt" property="crsAplcnt.brdt"/>
        <result column="mmbrAge" property="mmbrAge"/>
        <result column="A.qlfcAcqsYmd" property="crsAplcnt.qlfcAcqsYmd"/>
        <result column="A.qlfcSttsCdv" property="crsAplcnt.qlfcSttsCdv"/>
        <result column="A.qlfcRsltCode" property="crsAplcnt.qlfcRsltCode"/>
        <result column="A.qlfcVldYmd" property="crsAplcnt.qlfcVldYmd"/>
        <result column="A.fnshVldYmd" property="crsAplcnt.fnshVldYmd"/>
        <result column="diffYear" property="diffYear"/>
        <result column="diffMonth" property="diffMonth"/>
    </resultMap>
    <select id="selectList" parameterType="com.intermorph.crs.aplcnt.service.IMCrsAplcntCondition" resultMap="selectListResultMap">
/* IMCrsAplcntMapper.selectList */
         <if test='currentPageNo != 0'>
SELECT * FROM ( SELECT rownum rn, TB.* FROM (
        </if>

SELECT
       A.crs_aplcnt_id AS "A.crsAplcntId",
       A.crs_id AS "A.crsId",
       A.mmbr_esntl_id AS "A.mmbrEsntlId",
       A.mber_id AS "A.mberId",
       A.mber_nm AS "A.mberNm",
       A.mber_email_adres AS "A.mberEmailAdres",
       A.mmbr_telno AS "A.mmbrTelno",
       A.agncy_code AS "A.agncyCode",
	   A.agncy_nm AS "A.agncyNm",
	   A.work_dvsn_cdv  AS "A.workDvsnCdv",
       A.ttnfee_chg_cdv AS "A.ttnfeeChgCdv",
       A.dsr_aply_grd_cdv AS "A.dsrAplyGrdCdv",
       A.expt_sbj_yn AS "A.exptSbjYn",
       CASE 
       	WHEN A.ttnfee_chg_cdv IS NULL THEN C.ttnfee
        WHEN A.ttnfee_chg_cdv ='01' THEN C.ttnfee
        ELSE A.ttnfee
       END AS   "A.ttnfee",
       A.del_yn AS "A.delYn",
       A.frst_reger_id AS "A.frstRegerId",
       A.frst_reg_dt AS "A.frstRegDt",
       A.frst_reger_ip AS "A.frstRegerIp",
       A.last_mdfer_id AS "A.lastMdferId",
       A.last_mdfcn_dt AS "A.lastMdfcnDt",
       A.last_mdfer_ip AS "A.lastMdferIp",
       CONCAT('APLY=',B.APLY,',FNSH=',B.FNSH,',QLFC=',B.QLFC,',AGNCY_SRNG=',B.AGNCY_SRNG,'
       ,OPSECT_SRNG=',B.OPSECT_SRNG,'
       ,DPST=',B.DPST,'
       ,RNDM=',B.RNDM) AS "sttDdvs",
         CONCAT('APLY=',B.APLY_ID,',FNSH=',B.FNSH_ID,',QLFC=',B.QLFC_ID,',AGNCY_SRNG=',B.AGNCY_SRNG_ID,'
       ,OPSECT_SRNG=',B.OPSECT_SRNG_ID,'
       ,DPST=',B.DPST_ID,'
       ,RNDM=',B.RNDM_ID) AS "sttDdvIds",
       CONCAT('APLY=',B.APLY_DT,',FNSH=',B.FNSH_DT,',QLFC=',B.QLFC_DT,',AGNCY_SRNG=',B.AGNCY_SRNG_DT,'
       ,OPSECT_SRNG=',B.OPSECT_SRNG_DT,'
       ,DPST=',B.DPST_DT,'
       ,RNDM=',B.RNDM_DT) AS "sttDdvDts",
       CONCAT('eduAplTerm_bgnDt=',F.eduAplTerm_bgnDt
       ,',eduAplTerm_endDt=',F.eduAplTerm_endDt
       ,',eduTerm_bgnDt=',F.eduTerm_bgnDt
       ,',eduTerm_endDt=',F.eduTerm_endDt
       ,',slctnTerm_bgnDt=',F.slctnTerm_bgnDt
       ,',slctnTerm_endDt=',F.slctnTerm_endDt
       ,',payTerm_bgnDt=',F.payTerm_bgnDt
       ,',payTerm_endDt=',F.payTerm_endDt
       ,',fnshYmd_bgnDt=',F.fnshYmd_bgnDt
       ,',olfcfnshYmd_bgnDt=',F.olfcfnshYmd_bgnDt
       ) AS "crsDts",
       B.RNDM AS "rndmCdv",
       B.AGNCY_SRNG AS "agncySrngCdv",
       B.OPSECT_SRNG AS "opsectSrngCdv",
       B.AGNCY_SRNG_RMKS AS "agncySrngRmks",
       B.OPSECT_SRNG_RMKS AS "opsectSrngRmks",
       D.crs_grd_cdv AS "D.crsGrdCdv",
       D.crs_dvsn_cdv AS "D.crsDvsnCdv",
       C.edu_year AS "C.eduYear",
       C.edu_rnd AS "C.eduRnd",
       C.ttnfee AS "C.ttnfee",
       C.edu_hrs AS "C.eduHrs",
       C.prgrs_stts_cdv AS "C.prgrsSttsCdv",
       E.area_cdv AS "E.areaCdv",
       E.agncy_nm AS "E.agncyNm",
       rslt.brdt AS  "A.brdt",
         CASE 
         	WHEN rslt.brdt IS NULL THEN NULL
	         WHEN LENGTH(rslt.brdt)>7 THEN  (TO_CHAR(SYSDATETIME, 'yyyy') -  SUBSTRING(rslt.brdt,0,4))
         END AS    "mmbrAge",
       rslt.fnsh_stts_cdv AS  "A.fnshSttsCdv",
	   rslt.fnsh_rslt_code AS  "A.fnshRsltCode" ,
	   rslt.fnsh_ymd  AS  "A.fnshYmd",
	   rslt.qlfc_acqs_ymd AS  "A.qlfcAcqsYmd",
	   rslt.qlfc_stts_cdv AS  "A.qlfcSttsCdv",
	   rslt.qlfc_rslt_code AS  "A.qlfcRsltCode",
	   rslt.qlfc_vld_ymd AS  "A.qlfcVldYmd",
	   rslt.fnsh_vld_ymd AS  "A.fnshVldYmd",
	   NVL(hstry.diffYear,'0') AS "diffYear",
	   NVL(hstry.diffMonth,'0') AS "diffMonth"
  FROM im_crs_aplcnt A
       LEFT OUTER JOIN im_crs_aplcnt_rslt rslt ON  A.crs_aplcnt_id=rslt.crs_aplcnt_id
       INNER JOIN 
       (
			<include refid="view_aplcnt_cmmn_stts_inc"></include>
       )B
       ON     A.crs_aplcnt_id=B.tbl_ref_id
       INNER JOIN IM_CRS C ON A.crs_id=C.crs_id
       INNER JOIN IM_CRS_MSTR D ON C.crs_mstr_id=D.crs_mstr_id
       INNER JOIN IM_AGNCY E ON C.agncy_id=E.agncy_id
       INNER JOIN (
				   <include refid="view_aplcnt_cmmn_dt_inc"></include>
 			) F ON A.crs_id=F.tbl_ref_id
 	   LEFT OUTER JOIN 
 	   (
 	   		SELECT  
		    A.esntl_id,
			FLOOR(SUM(CEIL(CAST(A.dd AS DOUBLE)/31))/12) diffYear,
			MOD(SUM(CEIL(CAST(A.dd AS DOUBLE)/31)),12) diffMonth
		  FROM 
			(
				SELECT  A.member_srl,B.esntl_id,
					 DATEDIFF(CAST(work_end_ymd AS TIMESTAMP),CAST(work_bgn_ymd AS TIMESTAMP)) AS dd
				 FROM im_mmbr_work_hstry A 
				 INNER JOIN im_mmbr_hstry B ON A.member_srl=B.member_srl
				WHERE  
				  A.del_yn='N' AND
				 A.work_bgn_ymd IS NOT NULL AND  A.work_end_ymd IS NOT NULL 
				AND LENGTH( A.work_bgn_ymd)=14  AND LENGTH( A.work_end_ymd)=14
			) A
			GROUP BY A.esntl_id
 	   ) hstry ON 	hstry.esntl_id = A.mmbr_esntl_id	
 WHERE A.del_yn = 'N'
 	
 		<if test='scWord != null and !scWord.equals("")'>
            <if test='scKey.equals("crsAplcntId")'>
       			AND A.crs_aplcnt_id LIKE CONCAT('%', #{scWord}, '%')
            </if>
            <if test='scKey.equals("agncyNm")'>
       			AND E.agncy_nm LIKE CONCAT('%', #{scWord}, '%')
            </if>
            <if test='scKey.equals("mberNm")'>
       			AND  A.mber_nm  LIKE CONCAT('%', #{scWord}, '%')
            </if>
            <if test='scKey.equals("mberId")'>
       			AND  A.mber_id  LIKE CONCAT('%', #{scWord}, '%')
            </if>
            <if test='scKey.equals("mblTelno")'>
       			AND  A.mmbr_telno  LIKE CONCAT('%', #{scWord}, '%')
            </if>
            <if test='scKey.equals("eml")'>
       			AND  A.mber_email_adres  LIKE CONCAT('%', #{scWord}, '%')
            </if>
        </if>
 	
 		<if test='scMmbrEsntlId != null and !scMmbrEsntlId.equals("")'>
       			AND A.mmbr_esntl_id = #{scMmbrEsntlId} 
        </if>
 		<if test='scNotAplyCancleYn != null and !scNotAplyCancleYn.equals("")'>
 			 <if test='scNotAplyCancleYn.equals("Y")'>
       			AND B.APLY!='03'
            </if>
        </if>
 		<if test='scNotRNDMCancleYn != null and !scNotRNDMCancleYn.equals("")'>
 			 <if test='scNotRNDMCancleYn.equals("Y")'>
       			AND B.RNDM IN('02','04')
            </if>
        </if>
 	
 		<if test='scAplyStts != null and !scAplyStts.equals("")'>
 			<choose>
	            <when test='scAplyStts.equals("020405")'>
	            		AND B.APLY IN ('02','04','05')
	            </when>
	            <when test='scAplyStts.equals("02A")'>
	            		 <![CDATA[
	            		AND B.APLY = '02'
	            		AND F.fnshYmd_bgnDt < TO_CHAR(SYSDATETIME, 'yyyymmddhh24miss')
       					]]>
	            </when>
	            <otherwise>
	            	AND B.APLY = #{scAplyStts}
	            </otherwise>
        	</choose>
        </if>
 		<if test='scCrsId != null and !scCrsId.equals("")'>
       			AND  A.crs_id = #{scCrsId}
        </if>
 		<if test='scExptSbjYn != null and !scExptSbjYn.equals("")'>
       			AND  A.expt_sbj_yn = #{scExptSbjYn}
        </if>
 		<if test='scSttsCdvAGNCYSRNG != null and !scSttsCdvAGNCYSRNG.equals("")'>
       			AND  B.AGNCY_SRNG = #{scSttsCdvAGNCYSRNG}
        </if>
 		<if test='scSttsCdvOPSECTSRNG != null and !scSttsCdvOPSECTSRNG.equals("")'>
       			AND  B.OPSECT_SRNG = #{scSttsCdvOPSECTSRNG}
        </if>
 		<if test='scSttsCdvDPST != null and !scSttsCdvDPST.equals("")'>
       			AND  B.DPST = #{scSttsCdvDPST}
        </if>
        
 		<if test='scSttsCdvFNSH != null and !scSttsCdvFNSH.equals("")'>
       			AND  B.FNSH = #{scSttsCdvFNSH}
        </if>
 		<if test='scSttsCdvQLFC != null and !scSttsCdvQLFC.equals("")'>
       			AND  B.QLFC = #{scSttsCdvQLFC}
        </if>
        
         <if test='scCrsGrdCdv != null and !scCrsGrdCdv.equals("")'>
       			AND D.crs_grd_cdv = #{scCrsGrdCdv}
        </if>
        <if test='scCrsDvsnCdv != null and !scCrsDvsnCdv.equals("")'>
       			AND D.crs_dvsn_cdv = #{scCrsDvsnCdv}
        </if>
        <if test='scAgncyId != null and !scAgncyId.equals("")'>
       			AND C.agncy_id = #{scAgncyId}
        </if>
        <if test='scEduYear != null and !scEduYear.equals("")'>
       			AND C.edu_year = #{scEduYear}
        </if>
        <if test='scEduRnd != null and !scEduRnd.equals("")'>
       			AND C.edu_rnd = #{scEduRnd}
        </if>
        
        
  		<choose>
            <when test='orderbyKey == 8'>ORDER BY B.RNDM_ORDER ASC,A.frst_reg_dt ASC</when>
            <when test='orderbyKey == -8'>ORDER BY B.RNDM_ORDER DESC,A.frst_reg_dt ASC</when>
            <when test='orderbyKey == 7'>ORDER BY B.QLFC_DT ASC</when>
            <when test='orderbyKey == -7'>ORDER BY B.QLFC_DT DESC</when>
            <when test='orderbyKey == 6'>ORDER BY B.FNSH_DT ASC</when>
            <when test='orderbyKey == -6'>ORDER BY B.FNSH_DT DESC</when>
            <when test='orderbyKey == 5'>ORDER BY B.DPST_DT ASC</when>
            <when test='orderbyKey == -5'>ORDER BY B.DPST_DT DESC</when>
            <when test='orderbyKey == 4'>ORDER BY A.crs_aplcnt_id ASC</when>
            <when test='orderbyKey == -4'>ORDER BY A.crs_aplcnt_id DESC</when>
            <when test='orderbyKey == 3'>ORDER BY A.mber_nm ASC</when>
            <when test='orderbyKey == -3'>ORDER BY A.mber_nm DESC</when>
            <when test='orderbyKey == 2'>ORDER BY A.mber_id ASC</when>
            <when test='orderbyKey == -2'>ORDER BY A.mber_id DESC</when>
            <when test='orderbyKey == 1'>ORDER BY A.frst_reg_dt ASC</when>
            <when test='orderbyKey == -1'>ORDER BY A.frst_reg_dt DESC</when>
            <otherwise>ORDER BY A.frst_reg_dt DESC</otherwise>
        </choose>

        <if test='currentPageNo != 0'>
        ) TB ) WHERE rn BETWEEN #{firstItemNo}+1  AND #{firstItemNo} + #{recordCountPerPage}
        </if>
    </select>

    <select id="selectListCount" parameterType="com.intermorph.crs.aplcnt.service.IMCrsAplcntCondition" resultType="int">
/* IMCrsAplcntMapper.selectListCount */
SELECT COUNT(*) 
  FROM im_crs_aplcnt A
       LEFT OUTER JOIN im_crs_aplcnt_rslt rslt ON  A.crs_aplcnt_id=rslt.crs_aplcnt_id
       INNER JOIN 
       (		 
				<include refid="view_aplcnt_cmmn_stts_inc"></include>
       )B
       ON     A.crs_aplcnt_id=B.tbl_ref_id
       INNER JOIN IM_CRS C ON A.crs_id=C.crs_id
       INNER JOIN IM_CRS_MSTR D ON C.crs_mstr_id=D.crs_mstr_id
       INNER JOIN IM_AGNCY E ON C.agncy_id=E.agncy_id
       INNER JOIN (
				<include refid="view_aplcnt_cmmn_dt_inc"></include>
 			) F ON A.crs_id=F.tbl_ref_id
 WHERE A.del_yn = 'N' 
 		<if test='scWord != null and !scWord.equals("")'>
            <if test='scKey.equals("crsAplcntId")'>
       			AND A.crs_aplcnt_id LIKE CONCAT('%', #{scWord}, '%')
            </if>
            <if test='scKey.equals("agncyNm")'>
       			AND E.agncy_nm LIKE CONCAT('%', #{scWord}, '%')
            </if>
             <if test='scKey.equals("mberNm")'>
       			AND  A.mber_nm  LIKE CONCAT('%', #{scWord}, '%')
            </if>
            <if test='scKey.equals("mberId")'>
       			AND  A.mber_id  LIKE CONCAT('%', #{scWord}, '%')
            </if>
            <if test='scKey.equals("mblTelno")'>
       			AND  A.mmbr_telno  LIKE CONCAT('%', #{scWord}, '%')
            </if>
            <if test='scKey.equals("eml")'>
       			AND  A.mber_email_adres  LIKE CONCAT('%', #{scWord}, '%')
            </if>
        </if>
 	<if test='scMmbrEsntlId != null and !scMmbrEsntlId.equals("")'>
       			AND A.mmbr_esntl_id = #{scMmbrEsntlId}
        </if>
 		
 		<if test='scNotAplyCancleYn != null and !scNotAplyCancleYn.equals("")'>
 			 <if test='scNotAplyCancleYn.equals("Y")'>
       			AND B.APLY!='03'
            </if>
        </if>
        
 		<if test='scNotRNDMCancleYn != null and !scNotRNDMCancleYn.equals("")'>
 			 <if test='scNotRNDMCancleYn.equals("Y")'>
       			AND B.RNDM IN('02','04')
            </if>
        </if>
 	
 		<if test='scAplyStts != null and !scAplyStts.equals("")'>
 			<choose>
	            <when test='scAplyStts.equals("020405")'>
	            		AND B.APLY IN ('02','04','05')
	            </when>
	            <when test='scAplyStts.equals("02A")'>
	            		 <![CDATA[
	            		AND B.APLY = '02'
	            		AND F.fnshYmd_bgnDt < TO_CHAR(SYSDATETIME, 'yyyymmddhh24miss')
       					]]>
	            </when>
	            <otherwise>
	            	AND B.APLY = #{scAplyStts}
	            </otherwise>
        	</choose>
        </if>
        
 		<if test='scCrsId != null and !scCrsId.equals("")'>
       			AND  A.crs_id = #{scCrsId}
        </if>
        
        
 		<if test='scExptSbjYn != null and !scExptSbjYn.equals("")'>
       			AND  A.expt_sbj_yn = #{scExptSbjYn}
        </if>
 		<if test='scSttsCdvAGNCYSRNG != null and !scSttsCdvAGNCYSRNG.equals("")'>
       			AND  B.AGNCY_SRNG = #{scSttsCdvAGNCYSRNG}
        </if>
 		<if test='scSttsCdvOPSECTSRNG != null and !scSttsCdvOPSECTSRNG.equals("")'>
       			AND  B.OPSECT_SRNG = #{scSttsCdvOPSECTSRNG}
        </if>
 		<if test='scSttsCdvFNSH != null and !scSttsCdvFNSH.equals("")'>
       			AND  B.FNSH = #{scSttsCdvFNSH}
        </if>
 		<if test='scSttsCdvQLFC != null and !scSttsCdvQLFC.equals("")'>
       			AND  B.QLFC = #{scSttsCdvQLFC}
        </if>
 		<if test='scSttsCdvDPST != null and !scSttsCdvDPST.equals("")'>
       			AND  B.DPST = #{scSttsCdvDPST}
        </if>
        
        
        
           <if test='scCrsGrdCdv != null and !scCrsGrdCdv.equals("")'>
       			AND D.crs_grd_cdv = #{scCrsGrdCdv}
        </if>
        <if test='scCrsDvsnCdv != null and !scCrsDvsnCdv.equals("")'>
       			AND D.crs_dvsn_cdv = #{scCrsDvsnCdv}
        </if>
        <if test='scAgncyId != null and !scAgncyId.equals("")'>
       			AND C.agncy_id = #{scAgncyId}
        </if>
        <if test='scEduYear != null and !scEduYear.equals("")'>
       			AND C.edu_year = #{scEduYear}
        </if>
        <if test='scEduRnd != null and !scEduRnd.equals("")'>
       			AND C.edu_rnd = #{scEduRnd}
        </if>
    </select>

    <select id="selectOverAplyCount" parameterType="com.intermorph.crs.aplcnt.service.IMCrsAplcntVO" resultType="int">
	/* IMCrsAplcntMapper.selectOverAplyCount */
	SELECT COUNT(*)
	FROM   im_crs_aplcnt a
	       INNER JOIN im_cmmn_stts b
	       ON     a.crs_aplcnt_id=tbl_ref_id
	       AND    tbl_id         ='IM_CRS_APLCNT'
	WHERE  a.mmbr_esntl_id       =#{mmbrEsntlId}
	AND    a.crs_id              =#{crsId}
	AND    ref_nm                ='APLY'
	AND    a.del_yn='N'
	AND    stts_cdv             !='03'  
    </select>
    <select id="selectAplyCount" parameterType="com.intermorph.crs.aplcnt.service.IMCrsAplcntVO" resultType="int">
	/* IMCrsAplcntMapper.selectAplyCount */
	SELECT COUNT(*)
	FROM   im_crs_aplcnt a
	       INNER JOIN im_cmmn_stts b
	       ON     a.crs_aplcnt_id=tbl_ref_id
	       AND    tbl_id         ='IM_CRS_APLCNT'
	WHERE  a.crs_id              =#{crsId}
	AND    ref_nm                ='APLY'
	AND    a.del_yn='N' 
	AND    stts_cdv             !='03'  
    </select>
    <select id="selectAplyFishCount" parameterType="com.intermorph.crs.aplcnt.service.IMCrsAplcntCondition" resultType="int">
	/* IMCrsAplcntMapper.selectAplyFishCount */
			SELECT COUNT(*)
		FROM   im_crs_aplcnt_rslt a
		       INNER JOIN im_crs b
		       ON     a.crs_id=b.crs_id
		       INNER JOIN im_crs_mstr c ON b.crs_mstr_id = c.crs_mstr_id
		WHERE  a.fnsh_stts_cdv='02'
		AND c.crs_grd_cdv=#{scCrsGrdCdv}
		AND c.crs_dvsn_cdv=#{scCrsDvsnCdv}
		AND a.mmbr_esntl_id=#{scMmbrEsntlId}
    </select>
    
    <select id="selectAplyCrsRANDOM" parameterType="map" resultType="com.intermorph.crs.aplcnt.service.IMCrsAplcntVO">
	/* IMCrsAplcntMapper.selectAplyCrsRANDOM */
	SELECT 
		crs_aplcnt_id AS crsAplcntId
		,crs_id 
		FROM 
		im_crs_aplcnt A 
		WHERE 
			del_yn='N' 
			AND crs_id=#{crsId} 
			AND EXISTS
			(
			SELECT 1 FROM im_cmmn_stts Z  WHERE tbl_id='IM_CRS_APLCNT' AND ref_nm='APLY' AND A.crs_aplcnt_id=Z.tbl_ref_id
			AND stts_cdv!='03'
			)
		 ORDER BY RANDOM()  
    </select>
    
    <select id="selectAplyCrsOPSECTSRNG" parameterType="map" resultType="com.intermorph.cmmn.service.IMCmmnSttsVO">
	/* IMCrsAplcntMapper.selectAplyCrsOPSECTSRNG */
	SELECT 
		B.tbl_ref_id AS tblRefId
		,B.tbl_id  AS tblId
		,OPSECT_SRNG AS sttsCdv
		FROM 
		im_crs_aplcnt A
		INNER JOIN  
		(
		<include refid="view_aplcnt_cmmn_stts_inc"></include>
		
		) B
       ON     A.crs_aplcnt_id=B.tbl_ref_id
		WHERE 
			A.del_yn='N' 
			AND A.crs_id=#{crsId}  
			AND EXISTS
			(
			SELECT 1 FROM im_cmmn_stts Z  WHERE tbl_id='IM_CRS_APLCNT' AND ref_nm='APLY' AND A.crs_aplcnt_id=Z.tbl_ref_id
			AND stts_cdv!='03'
			)  
			
    </select>
    
    <select id="selectAplyStat" parameterType="map" resultType="com.intermorph.crs.aplcnt.service.IMCrsAplcntVO">
	/* IMCrsAplcntMapper.selectAplyStat */
	
SELECT COUNT(*) cnt , 'crsAply01Cnt' statType FROM im_crs_aplcnt A 
INNER JOIN im_cmmn_stts st ON  st.tbl_id='IM_CRS_APLCNT' AND ref_nm='APLY' AND stts_cdv='01' AND A.crs_aplcnt_id=st.tbl_ref_id
WHERE A.mmbr_esntl_id=#{mmbrEsntlId}  AND A.del_yn='N'
UNION ALL
 
SELECT COUNT(*) cnt , 'crsAply02Cnt' statType  FROM im_crs_aplcnt A 
INNER JOIN im_cmmn_stts st ON  st.tbl_id='IM_CRS_APLCNT' AND ref_nm='APLY' AND stts_cdv='02' AND A.crs_aplcnt_id=st.tbl_ref_id
WHERE A.mmbr_esntl_id=#{mmbrEsntlId}  AND A.del_yn='N'
UNION ALL
 
SELECT COUNT(*) cnt , 'crsFnsh02Cnt' statType FROM im_crs_aplcnt A 
INNER JOIN im_cmmn_stts st ON  st.tbl_id='IM_CRS_APLCNT' AND ref_nm='FNSH' AND stts_cdv='02' AND A.crs_aplcnt_id=st.tbl_ref_id
WHERE A.mmbr_esntl_id=#{mmbrEsntlId}  AND A.del_yn='N'
UNION ALL
 
SELECT COUNT(*) cnt , 'qlfcCnt' statType FROM im_mmbr_qlfc WHERE  qlfc_rslt_code IS NOT NULL AND  esntl_id=#{mmbrEsntlId} 

UNION ALL
SELECT COUNT(*)  cnt , 'manageCnt' statType
FROM   im_mmbr_qlfc
WHERE  SUBSTRING(lcnc_end_ymd,0,4)=TO_CHAR(SYSDATETIME, 'yyyy')
AND  qlfc_rslt_code IS NOT NULL AND  esntl_id=#{mmbrEsntlId} 

	
    </select>

    
    <sql id="view_aplcnt_cmmn_stts_inc">
    
    	 SELECT 
					 st.tbl_id,st.tbl_ref_id  ,
					 MAX(CASE WHEN st.ref_nm='APLY' THEN stts_cdv ELSE '' END) AS APLY,
					 MAX(CASE WHEN st.ref_nm='APLY' THEN last_mdfer_id ELSE '' END) AS APLY_ID,
					 MAX(CASE WHEN st.ref_nm='APLY' THEN last_mdfcn_dt ELSE '' END) AS APLY_DT,					 
					 MAX(CASE WHEN st.ref_nm='APLY' THEN stts_rmks ELSE '' END) AS APLY_RMKS,					 
					 MAX(CASE WHEN st.ref_nm='FNSH' THEN stts_cdv ELSE '' END) AS FNSH,
					 MAX(CASE WHEN st.ref_nm='FNSH' THEN last_mdfer_id ELSE '' END) AS FNSH_ID,
					 MAX(CASE WHEN st.ref_nm='FNSH' THEN last_mdfcn_dt ELSE '' END) AS FNSH_DT,
					 				 
					 MAX(CASE WHEN st.ref_nm='FNSH' THEN stts_rmks ELSE '' END) AS FNSH_RMKS,	
					 MAX(CASE WHEN st.ref_nm='QLFC' THEN stts_cdv ELSE '' END) AS QLFC,
					 MAX(CASE WHEN st.ref_nm='QLFC' THEN last_mdfer_id ELSE '' END) AS QLFC_ID,
					 MAX(CASE WHEN st.ref_nm='QLFC' THEN last_mdfcn_dt ELSE '' END) AS QLFC_DT,
					 MAX(CASE WHEN st.ref_nm='QLFC' THEN stts_rmks ELSE '' END) AS QLFC_RMKS,
					 MAX(CASE WHEN st.ref_nm='DPST' THEN stts_cdv ELSE '' END) AS DPST,
					 MAX(CASE WHEN st.ref_nm='DPST' THEN last_mdfer_id ELSE '' END) AS DPST_ID,
					 MAX(CASE WHEN st.ref_nm='DPST' THEN last_mdfcn_dt ELSE '' END) AS DPST_DT,
					 MAX(CASE WHEN st.ref_nm='DPST' THEN stts_rmks ELSE '' END) AS DPST_RMKS,
					 MAX(CASE WHEN st.ref_nm='AGNCY_SRNG' THEN stts_cdv ELSE '' END) AS AGNCY_SRNG,
					 MAX(CASE WHEN st.ref_nm='AGNCY_SRNG' THEN last_mdfer_id ELSE '' END) AS AGNCY_SRNG_ID,
					 MAX(CASE WHEN st.ref_nm='AGNCY_SRNG' THEN last_mdfcn_dt ELSE '' END) AS AGNCY_SRNG_DT,
					 MAX(CASE WHEN st.ref_nm='AGNCY_SRNG' THEN stts_rmks ELSE '' END) AS AGNCY_SRNG_RMKS,
					 MAX(CASE WHEN st.ref_nm='OPSECT_SRNG' THEN stts_cdv ELSE '' END) AS OPSECT_SRNG,
					 MAX(CASE WHEN st.ref_nm='OPSECT_SRNG' THEN last_mdfer_id ELSE '' END) AS OPSECT_SRNG_ID,
					 MAX(CASE WHEN st.ref_nm='OPSECT_SRNG' THEN last_mdfcn_dt ELSE '' END) AS OPSECT_SRNG_DT,
					 MAX(CASE WHEN st.ref_nm='OPSECT_SRNG' THEN stts_rmks ELSE '' END) AS OPSECT_SRNG_RMKS,
					 MAX(CASE WHEN st.ref_nm='RNDM' THEN stts_cdv ELSE '' END) AS RNDM ,
					 MAX(
                           CASE
                                    WHEN st.ref_nm='RNDM' AND stts_cdv='01' THEN 7
                                    WHEN st.ref_nm='RNDM' AND stts_cdv='02' THEN 1
                                    WHEN st.ref_nm='RNDM' AND stts_cdv='03' THEN 3
                                    WHEN st.ref_nm='RNDM' AND stts_cdv='04' THEN 2
                                    ELSE 0
                     END) AS RNDM_ORDER ,
					 MAX(CASE WHEN st.ref_nm='RNDM' THEN last_mdfer_id ELSE '' END) AS RNDM_ID,
					 MAX(CASE WHEN st.ref_nm='RNDM' THEN last_mdfcn_dt ELSE '' END) AS RNDM_DT
				 FROM im_cmmn_stts st WHERE st.tbl_id='IM_CRS_APLCNT' GROUP BY st.tbl_id,st.tbl_ref_id
    
	
	</sql>
	
    <sql id="view_aplcnt_cmmn_dt_inc">
    
		SELECT dt.tbl_id,dt.tbl_ref_id ,  
				 MAX(CASE WHEN dt.ref_nm='eduAplTerm' THEN bgn_dt ELSE '' END) AS eduAplTerm_bgnDt,
				 MAX(CASE WHEN dt.ref_nm='eduAplTerm' THEN end_dt ELSE '' END) AS eduAplTerm_endDt,
				 MAX(CASE WHEN dt.ref_nm='eduTerm' THEN bgn_dt ELSE '' END) AS eduTerm_bgnDt,
				 MAX(CASE WHEN dt.ref_nm='eduTerm' THEN end_dt ELSE '' END) AS eduTerm_endDt,
				 MAX(CASE WHEN dt.ref_nm='slctnTerm' THEN bgn_dt ELSE '' END) AS slctnTerm_bgnDt,
				 MAX(CASE WHEN dt.ref_nm='slctnTerm' THEN end_dt ELSE '' END) AS slctnTerm_endDt,
				 MAX(CASE WHEN dt.ref_nm='payTerm' THEN bgn_dt ELSE '' END) AS payTerm_bgnDt,
				 MAX(CASE WHEN dt.ref_nm='payTerm' THEN end_dt ELSE '' END) AS payTerm_endDt,
				 MAX(CASE WHEN dt.ref_nm='fnshYmd' THEN bgn_dt ELSE '' END) AS fnshYmd_bgnDt,
				 MAX(CASE WHEN dt.ref_nm='olfcfnshYmd' THEN bgn_dt ELSE '' END) AS olfcfnshYmd_bgnDt
				 FROM im_cmmn_dt dt WHERE dt.tbl_id='IM_CRS' GROUP BY dt.tbl_id,dt.tbl_ref_id
	</sql>
	
	
	<select id="selectAplyUserViewHistory" parameterType="map" resultType="com.intermorph.crs.aplcnt.service.IMCrsAplcntVO">
	/* IMCrsAplcntMapper.selectAplyUserViewHistory */
	SELECT * FROM 	
 		(	
 			SELECT 
 			 A.mmbr_esntl_id AS "mmbrEsntlId",
       D.crs_grd_cdv AS "crsGrdCdv",
       D.crs_dvsn_cdv AS "crsDvsnCdv",
       B.AGNCY_SRNG AS  "agncySrngCdv",
       B.AGNCY_SRNG_DT AS "agncySrngDt",
       B.AGNCY_SRNG_ID AS "agncySrngId",
       B.AGNCY_SRNG_RMKS AS  "agncySrngRmks",
       B.OPSECT_SRNG AS  "opsectSrngCdv",
       B.OPSECT_SRNG_DT AS  "opsectSrngDt",
       B.OPSECT_SRNG_ID AS  "opsectSrngId",
       B.OPSECT_SRNG_RMKS AS  "opsectSrngRmks",
       A.frst_reg_dt AS "frstRegDt"
         FROM
 			im_crs_aplcnt A
 			INNER JOIN (
 			SELECT 
					 st.tbl_id,st.tbl_ref_id  ,
					 MAX(CASE WHEN st.ref_nm='APLY' THEN stts_cdv ELSE '' END) AS APLY,
					 MAX(CASE WHEN st.ref_nm='AGNCY_SRNG' THEN stts_cdv ELSE '' END) AS AGNCY_SRNG,
					 MAX(CASE WHEN st.ref_nm='AGNCY_SRNG' THEN last_mdfer_id ELSE '' END) AS AGNCY_SRNG_ID,
					 MAX(CASE WHEN st.ref_nm='AGNCY_SRNG' THEN last_mdfcn_dt ELSE '' END) AS AGNCY_SRNG_DT,
					 MAX(CASE WHEN st.ref_nm='AGNCY_SRNG' THEN stts_rmks ELSE '' END) AS AGNCY_SRNG_RMKS,
					 MAX(CASE WHEN st.ref_nm='OPSECT_SRNG' THEN stts_cdv ELSE '' END) AS OPSECT_SRNG,
					 MAX(CASE WHEN st.ref_nm='OPSECT_SRNG' THEN last_mdfer_id ELSE '' END) AS OPSECT_SRNG_ID,
					 MAX(CASE WHEN st.ref_nm='OPSECT_SRNG' THEN last_mdfcn_dt ELSE '' END) AS OPSECT_SRNG_DT,
					 MAX(CASE WHEN st.ref_nm='OPSECT_SRNG' THEN stts_rmks ELSE '' END) AS OPSECT_SRNG_RMKS
				 FROM im_cmmn_stts st WHERE st.tbl_id='IM_CRS_APLCNT' GROUP BY st.tbl_id,st.tbl_ref_id
				)B
       ON     A.crs_aplcnt_id=B.tbl_ref_id
       INNER JOIN IM_CRS C ON A.crs_id=C.crs_id
       INNER JOIN IM_CRS_MSTR D ON C.crs_mstr_id=D.crs_mstr_id
       WHERE 
       A.del_yn = 'N'  AND B.APLY!='03'  AND A.mmbr_esntl_id=#{mmbrEsntlId} 
			UNION all	
					SELECT 
					A.mmbr_esntl_id AS "mmbrEsntlId",
       D.crs_grd_cdv AS "crsGrdCdv",
       'CRS_DVSN_001_01' AS "crsDvsnCdv",
       null AS  "agncySrngCdv",
       null AS "agncySrngDt",
       null AS "agncySrngId",
       null AS  "agncySrngRmks",
       B.OPSECT_SRNG AS  "opsectSrngCdv",
       B.OPSECT_SRNG_DT AS  "opsectSrngDt",
       B.OPSECT_SRNG_ID AS  "opsectSrngId",
       B.OPSECT_SRNG_RMKS AS  "opsectSrngRmks",
       A.frst_reg_dt AS "frstRegDt"   
  FROM im_wtst_aplcnt A
  INNER JOIN 
       (
				  SELECT 
					 st.tbl_id,st.tbl_ref_id, 
					 MAX(CASE WHEN st.ref_nm='APLY' THEN stts_cdv ELSE '' END) AS APLY, 
					 MAX(CASE WHEN st.ref_nm='OPSECT_SRNG' THEN stts_cdv ELSE '' END) AS OPSECT_SRNG,
					 MAX(CASE WHEN st.ref_nm='OPSECT_SRNG' THEN last_mdfer_id ELSE '' END) AS OPSECT_SRNG_ID,					 
					 MAX(CASE WHEN st.ref_nm='OPSECT_SRNG' THEN last_mdfcn_dt ELSE '' END) AS OPSECT_SRNG_DT,
					 MAX(CASE WHEN st.ref_nm='OPSECT_SRNG' THEN stts_rmks ELSE '' END) AS OPSECT_SRNG_RMKS
				 FROM im_cmmn_stts st WHERE st.tbl_id='IM_WTST_APLCNT' GROUP BY st.tbl_id,st.tbl_ref_id
     )B
       ON     A.wtst_aplcnt_id=B.tbl_ref_id
  INNER JOIN IM_wtst_place C ON A.wtst_place_id=C.wtst_place_id
  INNER JOIN IM_wtst D ON C.wtst_id=D.wtst_id
   WHERE 
       A.del_yn = 'N'  AND B.APLY!='03' AND A.mmbr_esntl_id=#{mmbrEsntlId} 
		) AA ORDER BY frstRegDt		 
	</select>
</mapper>